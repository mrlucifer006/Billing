<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Health</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4">

    {% if not authenticated %}
    <!-- Login Form -->
    <div class="max-w-sm w-full bg-white rounded-xl shadow-lg p-8 border border-slate-200">
        <h2 class="text-2xl font-bold text-slate-800 mb-6 text-center">Admin Login</h2>

        {% if error %}
        <div class="mb-4 p-3 bg-red-50 text-red-700 text-sm rounded-lg border border-red-100">
            {{ error }}
        </div>
        {% endif %}

        <form action="/health/login" method="POST" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Login ID</label>
                <input type="text" name="username" required
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                <input type="password" name="password" required
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
            </div>
            <button type="submit"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition shadow-md">
                Access Dashboard
            </button>
        </form>
    </div>

    {% else %}
    <!-- Dashboard -->
    <div class="max-w-4xl w-full">

        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">System Health</h1>
                <p class="text-slate-500">Real-time server monitoring</p>
            </div>
            <a href="/health/logout" class="text-sm text-red-600 hover:text-red-700 font-medium">Logout</a>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <!-- Active Sessions Card -->
            <div class="bg-white rounded-xl shadow p-6 border border-slate-200 flex items-center">
                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center mr-4">
                    <span class="material-icons text-blue-600">devices</span>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-slate-500 uppercase">Active Sessions</h3>
                    <p class="text-3xl font-bold text-slate-900" id="activeCount">--</p>
                </div>
            </div>

            <!-- Connection Strength Card -->
            <div class="bg-white rounded-xl shadow p-6 border border-slate-200 flex items-center">
                <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center mr-4" id="pingIconBg">
                    <span class="material-icons text-green-600" id="pingIcon">wifi</span>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-slate-500 uppercase">Connection Strength</h3>
                    <div class="flex items-baseline space-x-2">
                        <p class="text-3xl font-bold text-slate-900" id="pingStatus">Checking...</p>
                        <span class="text-sm text-slate-400 font-mono" id="pingMs">-- ms</span>
                    </div>
                </div>
            </div>

        </div>

        <!-- Service Status Table -->
        <div class="mt-6 bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-200">
                <h3 class="text-lg font-semibold text-slate-800">Service Status</h3>
            </div>
            <table class="w-full text-left">
                <thead class="bg-slate-50 border-b border-slate-200">
                    <tr>
                        <th class="px-6 py-3 text-xs font-semibold text-slate-500 uppercase">Endpoint</th>
                        <th class="px-6 py-3 text-xs font-semibold text-slate-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-xs font-semibold text-slate-500 uppercase">Latency</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    <!-- Home -->
                    <tr>
                        <td class="px-6 py-4 font-medium text-slate-700">Home (/)</td>
                        <td class="px-6 py-4" id="status-home">Checking...</td>
                        <td class="px-6 py-4 font-mono text-xs text-slate-500" id="latency-home">--</td>
                    </tr>
                    <!-- Participants -->
                    <tr>
                        <td class="px-6 py-4 font-medium text-slate-700">Participants (/participants)</td>
                        <td class="px-6 py-4" id="status-parts">Checking...</td>
                        <td class="px-6 py-4 font-mono text-xs text-slate-500" id="latency-parts">--</td>
                    </tr>
                    <!-- Scan Data -->
                    <tr>
                        <td class="px-6 py-4 font-medium text-slate-700">Active Sessions Data (/api/sessions)</td>
                        <td class="px-6 py-4" id="status-api">Checking...</td>
                        <td class="px-6 py-4 font-mono text-xs text-slate-500" id="latency-api">--</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Connection Log / Details -->
        <div class="mt-6 bg-white rounded-xl shadow p-6 border border-slate-200">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">Server Info</h3>
            <div class="flex items-center space-x-2 text-sm text-slate-600">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <span>Server is running and listening for connections.</span>
            </div>
            <p class="mt-2 text-xs text-slate-400">Server Time: <span id="serverTime">--</span></p>
        </div>

    </div>

    <script>
        async function checkEndpoint(url, statusId, latencyId) {
            const start = performance.now();
            try {
                const response = await fetch(url, { method: 'GET' }); // Changed to GET to avoid 405
                const end = performance.now();
                const latency = Math.round(end - start);

                document.getElementById(latencyId).innerText = latency + " ms";
                const statusEl = document.getElementById(statusId);

                if (response.ok) {
                    statusEl.innerHTML = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Online</span>';
                } else {
                    statusEl.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Error ${response.status}</span>`;
                }
                return latency; // Return for overall health calculation if needed
            } catch (e) {
                document.getElementById(latencyId).innerText = "--";
                document.getElementById(statusId).innerHTML = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Unreachable</span>';
                return 9999;
            }
        }

        async function updateStats() {
            // 1. Get Overall Stats
            const start = performance.now();
            try {
                const response = await fetch('/api/health_stats');
                const end = performance.now();
                const latency = Math.round(end - start);

                if (response.ok) {
                    const data = await response.json();

                    // Update Active Count
                    document.getElementById('activeCount').innerText = data.active_sessions;
                    document.getElementById('serverTime').innerText = new Date(data.server_time).toLocaleString();

                    // Update Latency UI
                    const pingMs = document.getElementById('pingMs');
                    const pingStatus = document.getElementById('pingStatus');
                    const icon = document.getElementById('pingIcon');
                    const iconBg = document.getElementById('pingIconBg');

                    pingMs.innerText = latency + " ms";

                    if (latency < 100) {
                        pingStatus.innerText = "Excellent";
                        pingStatus.className = "text-3xl font-bold text-green-600";
                        icon.innerText = "wifi";
                        icon.className = "material-icons text-green-600";
                        iconBg.className = "w-12 h-12 rounded-full bg-green-100 flex items-center justify-center mr-4";
                    } else if (latency < 300) {
                        pingStatus.innerText = "Good";
                        pingStatus.className = "text-3xl font-bold text-blue-600";
                        icon.innerText = "network_wifi";
                        icon.className = "material-icons text-blue-600";
                        iconBg.className = "w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center mr-4";
                    } else {
                        pingStatus.innerText = "Weak";
                        pingStatus.className = "text-3xl font-bold text-yellow-600";
                        icon.innerText = "signal_wifi_bad";
                        icon.className = "material-icons text-yellow-600";
                        iconBg.className = "w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center mr-4";
                    }
                }
            } catch (e) {
                document.getElementById('pingStatus').innerText = "Offline";
                document.getElementById('pingStatus').className = "text-3xl font-bold text-red-600";
            }

            // 2. Ping Endpoints
            checkEndpoint('/', 'status-home', 'latency-home');
            checkEndpoint('/participants', 'status-parts', 'latency-parts');
            checkEndpoint('/api/sessions', 'status-api', 'latency-api');
        }

        // Initial Load
        updateStats();

        // Refresh every 3 seconds
        setInterval(updateStats, 3000);
    </script>
    {% endif %}

</body>

</html>